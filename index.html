<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MCP Scorecard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #0d1117; color: #e6edf3; }

  /* Header */
  .header { padding: 24px 32px; border-bottom: 1px solid #21262d; display: flex; align-items: center; gap: 24px; flex-wrap: wrap; }
  .header h1 { font-size: 20px; font-weight: 600; white-space: nowrap; }
  .header h1 a { color: #e6edf3; text-decoration: none; }
  .header h1 a:hover { color: #58a6ff; }
  .header .nav { display: flex; gap: 16px; font-size: 13px; }
  .header .nav a { color: #7d8590; text-decoration: none; }
  .header .nav a:hover { color: #58a6ff; }
  .header .meta { font-size: 13px; color: #7d8590; display: flex; gap: 16px; margin-left: auto; }

  /* Stats bar */
  .stats-bar { padding: 16px 32px; border-bottom: 1px solid #21262d; display: flex; gap: 24px; flex-wrap: wrap; }
  .stat { text-align: center; }
  .stat .num { font-size: 22px; font-weight: 700; }
  .stat .label { font-size: 11px; color: #7d8590; text-transform: uppercase; letter-spacing: 0.5px; }
  .band-high .num { color: #3fb950; }
  .band-mod .num { color: #58a6ff; }
  .band-low .num { color: #d29922; }
  .band-vlow .num { color: #f85149; }
  .band-unk .num { color: #6e7681; }

  /* Controls */
  .controls { padding: 12px 32px; border-bottom: 1px solid #21262d; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .search { background: #161b22; border: 1px solid #30363d; color: #e6edf3; padding: 6px 12px; border-radius: 6px; font-size: 14px; width: 280px; }
  .search:focus { outline: none; border-color: #58a6ff; }
  .filter-btn { background: #21262d; border: 1px solid #30363d; color: #7d8590; padding: 4px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; }
  .filter-btn:hover, .filter-btn.active { background: #30363d; color: #e6edf3; border-color: #58a6ff; }
  .sort-select { background: #161b22; border: 1px solid #30363d; color: #e6edf3; padding: 6px 8px; border-radius: 6px; font-size: 12px; }
  .count-label { font-size: 13px; color: #7d8590; margin-left: auto; }

  /* Grid */
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1px; background: #21262d; padding: 1px; }

  /* Card */
  .card { background: #161b22; padding: 14px 16px; display: flex; flex-direction: column; gap: 8px; }
  .card:hover { background: #1c2128; }
  .card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
  .card-name { font-size: 13px; font-weight: 600; color: #e6edf3; word-break: break-all; line-height: 1.3; }
  .card-name .ns { color: #7d8590; font-weight: 400; }

  /* Score circle */
  .score-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; }
  .score-high { background: rgba(63,185,80,0.15); color: #3fb950; border: 2px solid #3fb950; }
  .score-mod { background: rgba(88,166,255,0.15); color: #58a6ff; border: 2px solid #58a6ff; }
  .score-low { background: rgba(210,153,34,0.15); color: #d29922; border: 2px solid #d29922; }
  .score-vlow { background: rgba(248,81,73,0.15); color: #f85149; border: 2px solid #f85149; }
  .score-unk { background: rgba(110,118,129,0.15); color: #6e7681; border: 2px solid #6e7681; }

  /* Category bars */
  .cat-bars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
  .cat-bar { display: flex; flex-direction: column; gap: 2px; }
  .cat-bar .bar-label { font-size: 9px; color: #7d8590; text-transform: uppercase; letter-spacing: 0.3px; }
  .cat-bar .bar-track { height: 4px; background: #21262d; border-radius: 2px; overflow: hidden; }
  .cat-bar .bar-fill { height: 100%; border-radius: 2px; }

  /* Signals */
  .signals { display: flex; flex-wrap: wrap; gap: 4px; }
  .signal { font-size: 10px; padding: 1px 6px; border-radius: 3px; }
  .signal-yes { background: rgba(63,185,80,0.15); color: #3fb950; }
  .signal-no { background: rgba(110,118,129,0.1); color: #484f58; }

  /* Flags */
  .flags { display: flex; flex-wrap: wrap; gap: 4px; }
  .flag { font-size: 10px; padding: 2px 6px; border-radius: 3px; background: rgba(248,81,73,0.15); color: #f85149; font-weight: 600; }

  /* Permissions detail */
  .perm-detail { font-size: 11px; color: #7d8590; }
  .perm-detail span { margin-right: 8px; }
</style>
</head>
<body>

<div class="header">
  <h1><a href="./">MCP Scorecard</a></h1>
  <div class="nav">
    <a href="about.html">About</a>
    <a href="https://github.com/gigabrainobserver/mcp-scorecard">GitHub</a>
  </div>
  <div class="meta">
    <span id="generated"></span>
    <span id="version"></span>
  </div>
</div>

<div class="stats-bar" id="stats-bar"></div>

<div class="controls">
  <input type="text" class="search" id="search" placeholder="Search servers...">
  <select class="sort-select" id="sort">
    <option value="score-desc">Score: High â†’ Low</option>
    <option value="score-asc">Score: Low â†’ High</option>
    <option value="name-asc">Name: A â†’ Z</option>
    <option value="flags-desc">Most Flags</option>
  </select>
  <div id="flag-filters" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
  <span class="count-label" id="count-label"></span>
</div>

<div class="grid" id="grid"></div>

<script>
let allServers = [];
let activeFlags = new Set();

function scoreClass(s) {
  if (s >= 80) return 'high';
  if (s >= 60) return 'mod';
  if (s >= 40) return 'low';
  if (s >= 20) return 'vlow';
  return 'unk';
}

function barColor(s) {
  if (s >= 80) return '#3fb950';
  if (s >= 60) return '#58a6ff';
  if (s >= 40) return '#d29922';
  if (s >= 20) return '#f85149';
  return '#6e7681';
}

const SIGNAL_LABELS = {
  has_source_repo: 'Repo',
  has_license: 'License',
  has_installable_package: 'Package',
  has_website_url: 'Website',
  has_icon: 'Icon',
  has_security_md: 'SECURITY.md',
  has_code_of_conduct: 'CoC',
  namespace_matches_owner: 'NS Match',
  repo_not_archived: 'Active Repo',
  unique_description: 'Unique Desc',
};

function renderCard(name, s) {
  const cls = scoreClass(s.trust_score);
  const parts = name.split('/');
  const ns = parts[0];
  const id = parts.slice(1).join('/');

  // Provenance signals
  let sigs = '';
  for (const [key, label] of Object.entries(SIGNAL_LABELS)) {
    const val = s.signals[key];
    sigs += `<span class="signal ${val ? 'signal-yes' : 'signal-no'}">${label}</span>`;
  }

  // Flags
  let flagsHtml = '';
  if (s.flags.length > 0) {
    flagsHtml = '<div class="flags">' + s.flags.map(f => `<span class="flag">${f}</span>`).join('') + '</div>';
  }

  // Permissions detail
  const secrets = s.signals.secret_env_var_count || 0;
  const transport = s.signals.transport_type_risk || 0;
  const cred = s.signals.credential_sensitivity || 0;
  let permHtml = `<div class="perm-detail">`;
  if (secrets > 0) permHtml += `<span>ðŸ”‘ ${secrets} secret${secrets > 1 ? 's' : ''}</span>`;
  permHtml += `<span>â¬¡ transport:${transport}</span>`;
  permHtml += `<span>ðŸ›¡ cred:${cred}</span>`;
  permHtml += `</div>`;

  return `<div class="card" data-name="${name}" data-score="${s.trust_score}" data-flags="${s.flags.join(',')}">
    <div class="card-top">
      <div class="card-name"><span class="ns">${ns}/</span>${id}</div>
      <div class="score-circle score-${cls}">${s.trust_score}</div>
    </div>
    <div class="cat-bars">
      ${['provenance','maintenance','popularity','permissions'].map(cat => {
        const v = s.scores[cat];
        return `<div class="cat-bar">
          <span class="bar-label">${cat.slice(0,4)}</span>
          <div class="bar-track"><div class="bar-fill" style="width:${v}%;background:${barColor(v)}"></div></div>
        </div>`;
      }).join('')}
    </div>
    <div class="signals">${sigs}</div>
    ${permHtml}
    ${flagsHtml}
  </div>`;
}

function render() {
  const q = document.getElementById('search').value.toLowerCase();
  const sort = document.getElementById('sort').value;

  let filtered = allServers.filter(([name, s]) => {
    if (q && !name.toLowerCase().includes(q)) return false;
    if (activeFlags.size > 0 && !s.flags.some(f => activeFlags.has(f))) return false;
    return true;
  });

  // Sort
  if (sort === 'score-desc') filtered.sort((a, b) => b[1].trust_score - a[1].trust_score);
  else if (sort === 'score-asc') filtered.sort((a, b) => a[1].trust_score - b[1].trust_score);
  else if (sort === 'name-asc') filtered.sort((a, b) => a[0].localeCompare(b[0]));
  else if (sort === 'flags-desc') filtered.sort((a, b) => b[1].flags.length - a[1].flags.length || b[1].trust_score - a[1].trust_score);

  document.getElementById('grid').innerHTML = filtered.map(([n, s]) => renderCard(n, s)).join('');
  document.getElementById('count-label').textContent = `${filtered.length} of ${allServers.length} servers`;
}

async function init() {
  const resp = await fetch('./output/index.json');
  const data = await resp.json();

  document.getElementById('generated').textContent = `Generated: ${new Date(data.generated_at).toLocaleDateString()}`;
  document.getElementById('version').textContent = `v${data.version}`;

  allServers = Object.entries(data.servers);

  // Stats
  const bands = { high: 0, mod: 0, low: 0, vlow: 0, unk: 0 };
  const flagCounts = {};
  let totalScore = 0;
  for (const [, s] of allServers) {
    bands[scoreClass(s.trust_score)]++;
    totalScore += s.trust_score;
    for (const f of s.flags) flagCounts[f] = (flagCounts[f] || 0) + 1;
  }
  const avg = Math.round(totalScore / allServers.length);
  const flagged = allServers.filter(([,s]) => s.flags.length > 0).length;

  document.getElementById('stats-bar').innerHTML = `
    <div class="stat"><div class="num">${allServers.length}</div><div class="label">Servers</div></div>
    <div class="stat"><div class="num">${avg}</div><div class="label">Avg Score</div></div>
    <div class="stat band-high"><div class="num">${bands.high}</div><div class="label">High Trust</div></div>
    <div class="stat band-mod"><div class="num">${bands.mod}</div><div class="label">Moderate</div></div>
    <div class="stat band-low"><div class="num">${bands.low}</div><div class="label">Low Trust</div></div>
    <div class="stat band-vlow"><div class="num">${bands.vlow}</div><div class="label">Very Low</div></div>
    <div class="stat band-unk"><div class="num">${bands.unk}</div><div class="label">Suspicious</div></div>
    <div class="stat"><div class="num" style="color:#f85149">${flagged}</div><div class="label">Flagged</div></div>
  `;

  // Flag filter buttons
  const sortedFlags = Object.entries(flagCounts).sort((a, b) => b[1] - a[1]);
  document.getElementById('flag-filters').innerHTML = sortedFlags.map(([f, c]) =>
    `<button class="filter-btn" data-flag="${f}">${f} (${c})</button>`
  ).join('');

  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const flag = btn.dataset.flag;
      if (activeFlags.has(flag)) { activeFlags.delete(flag); btn.classList.remove('active'); }
      else { activeFlags.add(flag); btn.classList.add('active'); }
      render();
    });
  });

  document.getElementById('search').addEventListener('input', render);
  document.getElementById('sort').addEventListener('change', render);

  render();
}

init();
</script>
</body>
</html>
